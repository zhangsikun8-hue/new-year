<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <!-- å…³é”®ï¼šviewport ä¿æŒä¸ç¼©æ”¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>æ–°å¹´å¿«ä¹</title>

  <style>
    :root{
      --bg1:#fff7ee;
      --ink:#6d4b3e;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg1);
      font-family: "Ma Shan Zheng","ZCOOL KuaiLe", cursive, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      touch-action: manipulation;
    }
    body{
      background: radial-gradient(1200px 800px at 50% 90%, #fff1d6 0%, rgba(255,241,214,0) 60%),
                  radial-gradient(900px 600px at 10% 10%, #ffe8ef 0%, rgba(255,232,239,0) 55%),
                  radial-gradient(1000px 900px at 90% 20%, #f7f0ff 0%, rgba(247,240,255,0) 60%),
                  linear-gradient(180deg, #fffaf2, #fff7ee);
    }

    canvas{
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;      /* å…³é”®ï¼šCSS å°ºå¯¸é”æ­» */
      height: 100vh;
      inset: 0;
      display: block;
      touch-action: manipulation;
    }

    #tip{
      position: fixed;
      left: 50%;
      bottom: calc(22px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      font-size: 18px;
      color: rgba(120,80,60,0.85);
      background: rgba(255,255,255,0.6);
      padding: 8px 14px;
      border-radius: 999px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      backdrop-filter: blur(4px);
      user-select: none;
      z-index: 30;
      pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€tipï¼Œç¡®ä¿èƒ½ç‚¹åˆ°bodyè§¦å‘éŸ³ä¹ */
      transition: opacity 0.5s;
    }

    #audioToggle{
      position: fixed;
      right: 14px;
      top: calc(14px + env(safe-area-inset-top));
      font-size: 14px;
      color: var(--ink);
      background: rgba(255,255,255,0.75);
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      user-select: none;
      cursor: pointer;
      z-index: 30;
    }

    /* é®ç½©å±‚ï¼šç”¨äºç‚¹å‡»ä¿¡çº¸å¤–éƒ¨å…³é—­ä¿¡çº¸ */
    #mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 9;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
      backdrop-filter: blur(2px);
    }
    #mask.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* ä¿¡çº¸ï¼ˆé«˜åº¦ç”¨ dvhï¼Œæ”¯æŒå†…éƒ¨æ»šåŠ¨ï¼‰ */
    #paper{
      position: fixed;
      left: 50%;
      top: 45%;
      transform: translate(-50%, -50%) scale(0.6);
      width: min(86vw, 520px);
      height: min(70dvh, 650px);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,247,235,0.96)),
                  repeating-linear-gradient(90deg, rgba(180,140,110,0.03) 0 2px, transparent 2px 6px);
      border: 1px solid rgba(160,120,90,0.25);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.12);
      padding: 22px 20px;
      opacity: 0;
      filter: saturate(1.05);
      transform-origin: center;
      transition: opacity 1.2s ease, transform 1.2s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 10;
    }
    #paper.show{
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    #paper.fold{
      transform: translate(-50%, -50%) scale(0.9) scaleY(0.05);
      opacity: 0;
      transition: transform 1.4s ease, opacity 1.0s ease;
      pointer-events: none;
    }

    #paper::before,
    #paper::after{
      content:"";
      position:absolute;
      width:28px;
      height:28px;
      background: radial-gradient(circle at 0 0, rgba(140,90,60,0.25), transparent 70%);
      opacity:.25;
      pointer-events:none;
    }
    #paper::before{ right:0; top:0; transform: rotate(90deg); }
    #paper::after{ left:0; bottom:0; transform: rotate(-90deg); }

    #letterContent{
      white-space: pre-wrap;
      font-size: clamp(16px, 4.2vw, 22px);
      line-height: 1.8;
      color: #5a3c2f;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      margin-bottom: 20px;
    }

    #dove{
      position: fixed;
      left: -20vw;
      top: 20vh;
      font-size: 34px;
      opacity: 0;
      transform: translateX(0) translateY(0) scale(1);
      /* ç»Ÿä¸€ä½¿ç”¨ transition æ§åˆ¶ä½ç½®ç§»åŠ¨ï¼Œå®ç°å¹³æ»‘é£è¡ŒåŠ¨ç”» */
      transition: left 2.5s ease-in-out, top 2.5s ease-in-out, opacity 1s ease, transform 2.5s ease-in-out;
      pointer-events: none;
      z-index: 20;
    }
    
    /* ä¿¡é¸½åœç•™çŠ¶æ€ï¼šé£åˆ°å³ä¸Šè§’ */
    #dove.rest {
      left: 85vw;  /* å±å¹•å³ä¾§ */
      top: 8vh;    /* å±å¹•ä¸Šæ–¹ */
      opacity: 1;
      transform: scale(1.3) rotate(10deg);
      cursor: pointer;
      pointer-events: auto; /* å…è®¸ç‚¹å‡» */
      animation: hoverDove 3s ease-in-out infinite alternate;
    }

    @keyframes hoverDove {
      0% { transform: scale(1.3) rotate(10deg) translateY(0); }
      100% { transform: scale(1.3) rotate(10deg) translateY(-10px); }
    }
  </style>
</head>

<body>
  <canvas id="c"></canvas>

  <div id="audioToggle">ğŸµ éŸ³ä¹ï¼šå…³</div>
  <div id="tip">ğŸ‘‡ ç‚¹å‡»å±å¹•å¼€å§‹æ”¾çƒŸèŠ±</div>

  <!-- å¢åŠ é®ç½©å±‚ -->
  <div id="mask"></div>

  <div id="paper"><div id="letterContent"></div></div>
  <div id="dove">ğŸ•Šï¸</div>

  <audio id="bgm" loop preload="auto">
    <source src="./bgm.mp3" type="audio/mpeg">
  </audio>

  <script>
    (() => {
      const canvas = document.getElementById('c');
      const ctx = canvas.getContext('2d', { alpha: true });
      const tip = document.getElementById('tip');
      const paper = document.getElementById('paper');
      const mask = document.getElementById('mask');
      const letterContent = document.getElementById('letterContent');
      const dove = document.getElementById('dove');
      const bgm = document.getElementById('bgm');
      const audioToggle = document.getElementById('audioToggle');

      // ======= é€‚é…æ ¸å¿ƒï¼šå›ºå®š CSS å°ºå¯¸ + DPR ç»˜åˆ¶ï¼Œç¦æ­¢ç´¯è®¡ scale =======
      let W = 0, H = 0, DPR = 1;

      function getViewportSize() {
        const vv = window.visualViewport;
        const w = Math.max(1, Math.round(vv ? vv.width : window.innerWidth));
        const h = Math.max(1, Math.round(vv ? vv.height : window.innerHeight));
        return { w, h };
      }

      function resize(force = false) {
        const { w, h } = getViewportSize();
        const dpr = Math.min(3, window.devicePixelRatio || 1); 
        if (!force && w === W && h === H && dpr === DPR) return;

        W = w; H = h; DPR = dpr;

        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';

        canvas.width = Math.round(W * DPR);
        canvas.height = Math.round(H * DPR);

        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }

      resize(true);
      window.addEventListener('resize', () => resize(false), { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(() => resize(true), 50), { passive: true });
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => resize(false), { passive: true });
        window.visualViewport.addEventListener('scroll', () => resize(false), { passive: true });
      }

      // âœ… å…è®¸åœ¨ä¿¡çº¸åŒºåŸŸå†…æ­£å¸¸æ»šåŠ¨
      document.addEventListener('touchmove', (e) => {
        const target = e.target;
        if (target && target.closest && target.closest('#paper')) {
          return;
        }
        e.preventDefault();
      }, { passive: false });

      // ======= ğŸµ éŸ³ä¹æ§åˆ¶é€»è¾‘ =======
      let audioOn = false;

      function tryPlayAudio() {
        if (!audioOn && bgm.paused) {
          bgm.play().then(() => {
            audioOn = true;
            audioToggle.textContent = "ğŸµ éŸ³ä¹ï¼šå¼€";
            document.removeEventListener('click', tryPlayAudio);
            document.removeEventListener('touchstart', tryPlayAudio);
          }).catch((e) => {
            console.log("è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡äº¤äº’", e);
          });
        }
      }

      document.addEventListener('WeixinJSBridgeReady', function() { tryPlayAudio(); }, false);
      document.addEventListener('click', tryPlayAudio, { once: false });
      document.addEventListener('touchstart', tryPlayAudio, { once: false });

      audioToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        if (audioOn) {
          bgm.pause();
          audioOn = false;
          audioToggle.textContent = "ğŸµ éŸ³ä¹ï¼šå…³";
        } else {
          bgm.play().then(() => {
            audioOn = true;
            audioToggle.textContent = "ğŸµ éŸ³ä¹ï¼šå¼€";
          }).catch(e => console.log(e));
        }
      }, { passive: false });


      // ======= é˜¶æ®µçŠ¶æ€æœº =======
      const STAGE = { FIREWORKS:1, TRANSFORM:2, LETTER:3, LOOP:4 };
      let stage = STAGE.FIREWORKS;

      // ======= ç¥ç¦é€å­— =======
      const fullBlessingRaw = "ç¥ä¸–ç•Œä¸Šæœ€æœ€æœ€å¯çˆ±ï¼Œæœ€æœ€æœ€æ¸©æŸ”ï¼Œæœ€æœ€æœ€å¥½çš„å¦¹å¦¹æ–°å¹´å¿«ä¹ï¼Œä¸‡äº‹å¦‚æ„ï¼Œèº«ä½“å¥åº·ï¼Œé«˜è€ƒé¡ºåˆ©ï¼";
      const blessingChars = [...fullBlessingRaw];
      let blessingIndex = 0;
      let blessingShown = "";
      let blessingVisible = true;

      function drawBlessingText() {
        if (!blessingShown || !blessingVisible) return;

        ctx.save();
        ctx.font = "bold 28px Ma Shan Zheng, ZCOOL KuaiLe, cursive";
        ctx.fillStyle = "rgba(180, 60, 80, 0.95)";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const lines = blessingShown.split('ï¼Œ');
        const lineHeight = 42;
        const totalHeight = lines.length * lineHeight;
        const startY = H / 2 - totalHeight / 2 + lineHeight / 2;

        ctx.shadowColor = "rgba(255, 200, 150, 0.4)";
        ctx.shadowBlur = 8;

        lines.forEach((line, i) => {
          const displayLine = i < lines.length - 1 ? line + 'ï¼Œ' : line;
          const alpha = Math.min(1, 0.7 + Math.sin(Date.now() / 1000 + i) * 0.3);
          ctx.globalAlpha = alpha;
          ctx.fillText(displayLine, W / 2, startY + i * lineHeight);
        });

        ctx.restore();
      }

      // ======= çƒŸèŠ±ç²’å­ç³»ç»Ÿ(Canvas) =======
      const fireworks = [];
      const particles = [];
      const gravity = 0.04;

      function rand(min, max){ return Math.random()*(max-min)+min; }

      function softColor(){
        const hues = [10, 25, 40, 320, 280, 200];
        const h = hues[Math.floor(Math.random()*hues.length)];
        const s = rand(60, 85);
        const l = rand(60, 75);
        return `hsl(${h} ${s}% ${l}%)`;
      }

      class Firework{
        constructor(x, y, tx, ty, size=1, onExplode=null){
          this.x=x; this.y=y; this.tx=tx; this.ty=ty;
          const angle=Math.atan2(ty-y, tx-x);
          const speed=rand(6,8)*size;
          this.vx=Math.cos(angle)*speed;
          this.vy=Math.sin(angle)*speed;
          this.size=size;
          this.color=softColor();
          this.trail=[];
          this.onExplode=onExplode;
        }
        update(){
          this.trail.push([this.x,this.y]);
          if(this.trail.length>8) this.trail.shift();
          this.x+=this.vx;
          this.y+=this.vy;
          this.vy+=gravity*0.6;
          const dx=this.tx-this.x, dy=this.ty-this.y;
          if(dx*dx+dy*dy<18*18){
            this.explode();
            return false;
          }
          return true;
        }
        draw(){
          ctx.save();
          ctx.strokeStyle=this.color;
          ctx.lineWidth=2*this.size;
          ctx.beginPath();
          for(let i=0;i<this.trail.length;i++){
            const [tx,ty]=this.trail[i];
            if(i===0) ctx.moveTo(tx,ty);
            else ctx.lineTo(tx,ty);
          }
          ctx.stroke();
          ctx.restore();
        }
        explode(){
          const count = Math.floor(rand(40,60)*this.size);
          for(let i=0;i<count;i++){
            particles.push(new Particle(this.x,this.y,this.color,this.size));
          }
          if(this.onExplode) this.onExplode(this.x,this.y);
        }
      }

      class Particle{
        constructor(x,y,color,size=1){
          this.x=x; this.y=y;
          this.color=color;
          const ang=rand(0,Math.PI*2);
          const sp=rand(1.5,5.2)*size;
          this.vx=Math.cos(ang)*sp;
          this.vy=Math.sin(ang)*sp;
          this.life=rand(50,90);
          this.alpha=1;
          this.size=size;
        }
        update(){
          this.x+=this.vx;
          this.y+=this.vy;
          this.vy+=gravity;
          this.vx*=0.985;
          this.vy*=0.985;
          this.life--;
          this.alpha = this.life/90;
          return this.life>0;
        }
        draw(){
          ctx.save();
          ctx.globalAlpha=this.alpha;
          ctx.fillStyle=this.color;
          ctx.shadowColor=this.color;
          ctx.shadowBlur=10*this.size;
          ctx.beginPath();
          ctx.arc(this.x,this.y,rand(1.1,2.4)*this.size,0,Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }

      function launchFirework(x, y, size=1, onExplode=null){
        const startX = (x ?? rand(W*0.2, W*0.8));
        const startY = H + 30;
        const targetX = (x ?? startX);
        const targetY = (y ?? rand(H*0.15, H*0.55));
        fireworks.push(new Firework(startX,startY,targetX,targetY,size,onExplode));
      }

      // ======= é˜¶æ®µ2ï¼šå¤§çƒŸèŠ± + æ–°å¹´å¿«ä¹ =======
      const NYE_HOLD_MS = 500;   // â€œæ–°å¹´å¿«ä¹â€åœç•™æ—¶é•¿ï¼ˆè¶Šå°è¶Šå¿«è¿›å…¥ä¿¡ï¼‰
      const NYE_FADE_MS = 600;   // â€œæ–°å¹´å¿«ä¹â€æ·¡å‡ºæ—¶é•¿

      let nyeTextAlpha = 0;
      let nyeFading = false;
      let nyeStartTime = 0;

      function startStage2(){
        stage = STAGE.TRANSFORM;
        blessingVisible = false;

        setTimeout(() => {
          launchFirework(W/2, H*0.28, 1.5, () => {
            nyeTextAlpha = 1;
            nyeFading = false;
            nyeStartTime = performance.now();

            setTimeout(() => {
              nyeFading = true;
              // è®©ä¿¡çº¸åœ¨â€œæ–°å¹´å¿«ä¹â€å‡ºç°åå°½å¿«å±•å¼€
              setTimeout(startStage3, 300);
            }, NYE_HOLD_MS);
          });
        }, 600);
      }

      function drawNYEText(){
        if(nyeTextAlpha<=0) return;
        const t = performance.now();
        if(nyeFading){
          const dt = (t - (nyeStartTime+NYE_HOLD_MS))/NYE_FADE_MS;
          nyeTextAlpha = Math.max(0, 1-dt);
        }
        ctx.save();
        ctx.globalAlpha = nyeTextAlpha;
        ctx.font = "64px Ma Shan Zheng, ZCOOL KuaiLe, cursive";
        ctx.fillStyle = "rgba(233,120,140,0.95)";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.shadowColor="rgba(240,170,120,0.8)";
        ctx.shadowBlur=18;
        ctx.fillText("æ–°å¹´å¿«ä¹", W/2, H*0.42);
        ctx.restore();
      }

      // ======= é˜¶æ®µ3ï¼šä¿¡çº¸é€å­— =======
      const letterText = `To zjyï¼š

æ–°å¹´å¿«ä¹ï¼ï¼ï¼ï¼ï¼

è®°å¾—ç¬¬ä¸€æ¬¡è®¤è¯†ä½ çš„æ—¶å€™æˆ‘æ‰é«˜ä¸€ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆå‰é¢çš„åå‡ å¹´æˆ‘ä¸€ç‚¹å°è±¡éƒ½æ²¡æœ‰ï¼Œå½“æ—¶é«˜ä¸€æ—¶æˆ‘éƒ½æ‡µäº†ï¼Œæˆ‘ç«Ÿç„¶æœ‰è¿™ä¹ˆè¿™ä¹ˆå¯çˆ±çš„å¦¹å¦¹ï¼Œä»å°åˆ°å¤§éƒ½è¶…æƒ³æœ‰ä¸ªå¦¹å¦¹ï¼ŒæŒºé—æ†¾çš„ï¼Œé«˜ä¸­å¿™ï¼Œæˆ‘ä¹Ÿä¸æ€ä¹ˆç¤¾äº¤ï¼Œæ²¡æ€ä¹ˆå’Œä½ èŠå¤©

è¿™ä¸ªå­¦æœŸçœŸçš„å¥½å¿™å•Šï¼Œæˆ‘å‡ ä¹ä¸€ä¸ªå­¦æœŸçš„æ—¶é—´å­¦ç€ä¸‰å››ä¸ªå­¦æœŸçš„å†…å®¹ï¼Œé‚£æ®µæ—¶é—´å‹åŠ›çœŸçš„è¶…çº§è¶…çº§å¤§ï¼Œæ¯æ™šéƒ½å‡ ä¹åœ¨åºŠä¸Šå‘å‘†ä¸€ä¸ªå°æ—¶æ‰ç¡å¾—ç€ï¼Œæˆ‘è·Ÿçˆ¶æ¯è¯´ä¸äº†ï¼Œä»–ä»¬åªä¼šè¯´æ¯ä¸ªäººéƒ½è¿™æ ·ï¼Œæœ‹å‹å‡ ä¹éƒ½æ˜¯ç”·å­©å­ï¼Œè¯´è¿™ç§äº‹æƒ…æŒºå¥‡æ€ªçš„ï¼Œå¹¸å¥½æœ‰ä½ é™ªç€æˆ‘èŠå¤©ï¼ŒçœŸçš„çœŸçš„è¶…çº§è°¢è°¢ä½ ï¼ŒæŒºå¤šæ—¶å€™å¾®ä¿¡å¼¹ä¸ªæ¶ˆæ¯æˆ‘éƒ½è¶…çº§æœŸç›¼æ˜¯ä½ çš„ï¼Œä½ çœŸçš„æ˜¯å…¨å®‡å®™æœ€æœ€æœ€å¥½çš„å¦¹å¦¹ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼

å¯èƒ½åœ¨å’Œä½ ä¹Ÿæ„Ÿå—å¾—åˆ°ï¼Œæˆ‘æ¯”è¾ƒå­¤ç‹¬ï¼Œä¹Ÿä¸å¤ªä¼šä¸»åŠ¨è¯´è¯ã€èŠå¤©ï¼Œä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªå­¦æœŸè¯çªç„¶å˜å¤šäº†å‘¢ï¼Œä¸€æ˜¯ç°åœ¨æ‰æœ‰ç©ºï¼ŒäºŒæ˜¯å’Œä½ èŠå¤©çœŸçš„å¾ˆæœ‰è¶£ï¼Œé«˜ä¸‰å¤ªè‹¦é€¼äº†ï¼Œæˆ‘å¸Œæœ›èƒ½ç»™æˆ‘çš„å¦¹å¦¹å¸¦æ¥ä¸€äº›æƒŠå–œä¸æ¸©æš–

æˆ‘ä¸å¤ªä¼šè¯´ç…½æƒ…çš„è¯ï¼Œç°å®ä¸­ææ€•è¿ä¸Šé¢çš„éƒ½è¯´ä¸å‡ºå£ï¼ŒËƒá·„Ì£Ì£Ì¥âŒ“Ë‚á·…Ì£Ì£Ì¥ ä½†è¿˜æ˜¯æƒ³è¯´ï¼šäºæˆ‘è€Œè¨€ï¼Œæœ‰ä½ é™ªæˆ‘èŠå¤©çœŸçš„çœŸçš„å¹¸è¿è‡³æï¼Œå¦‚æœæˆ‘ä¹Ÿç»™æˆ‘çš„å¾®ä¿¡åˆ—è¡¨æ’ä¸ªåºçš„è¯ï¼Œé‚£ä½ ä¸€å®šæ˜¯A+++++++++++++ï¼ï¼ï¼ï¼ï¼â™¡(.â—œÏ‰â—.)â™¡

å¥½å§ï¼Œæˆ‘å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆä¼šè¡¨è¾¾æ„Ÿæƒ…çš„äººï¼Œæˆ‘çš„æ–‡å­—å’Œè¯è¯­å¯¹äºæˆ‘çš„æ„Ÿæƒ…å¤ªè‹ç™½äº†ï¼ˆå”‰ï¼Œæœ‰å¥½å¤šæƒ³è¯´çš„ï¼Œä½†åˆä¸çŸ¥é“è¯´ä»€ä¹ˆï¼‰ï¼Œé‚£å°±åˆ°è¿™å§ï¼Œå¸Œæœ›å¦¹å¦¹åœ¨ä»Šåçš„æ¯ä¸€å¤©éƒ½èƒ½å¼€å¼€å¿ƒå¿ƒï¼ï¼ï¼ï¼  (..â€ºá´—â€¹..) â¸â¸â¸â¸â¸ â™¡  

è¶…çº§è¶…çº§çˆ±ä½ çš„å“¥å“¥(â™¡>ğ–¥¦<)/â™¥`;

      function typeWriter(el, text, minDelay=300, maxDelay=500){
        return new Promise(resolve=>{
          let i=0;
          el.textContent="";
          const tick=()=>{
            el.textContent += text[i++];
            if(i>=text.length){ resolve(); return; }
            setTimeout(tick, rand(minDelay,maxDelay));
          };
          tick();
        });
      }

      function startStage3(){
        stage = STAGE.LETTER;
        paper.classList.add('show');
        tip.style.opacity = 0;
        
        // ä¿®æ”¹1ï¼šè°ƒæ•´æ‰“å­—é€Ÿåº¦ï¼ˆæ›´å¿«ï¼‰ï¼Œå‡å°æ¯ä¸¤ä¸ªå­—ç¬¦æµ®ç°é—´éš”
        typeWriter(letterContent, letterText, 150, 350).then(()=>{
          setTimeout(startStage4, 2500);
        });
      }

      // ======= é˜¶æ®µ4ï¼šæ”¶æ‹¢ â†’ ä¿¡é¸½åœç•™ â†’ å¾ªç¯äº¤äº’ =======
      function startStage4(){
        paper.classList.add('fold'); // æ”¶èµ·ä¿¡çº¸
        
        // å»¶æ—¶è®©ä¿¡çº¸æ”¶èµ·åŠ¨ç”»æ’­æ”¾ä¸€ä¼šï¼Œç„¶åæ˜¾ç¤ºä¿¡é¸½
        setTimeout(()=>{
          paper.classList.remove('show'); // ç¡®ä¿éšè—
          // ä¿®æ”¹2ï¼šä¿¡é¸½é£å‘å³ä¸Šè§’å¹¶åœç•™ (.rest)
          dove.classList.add('rest');
          
          launchFirework(W/2, H*0.28, 1.5, ()=>{
            nyeTextAlpha = 1;
            nyeFading = true;
            nyeStartTime = performance.now() - 1500;
          });
        }, 800);

        setTimeout(()=>{
          stage = STAGE.LOOP;
          tip.style.opacity = 1;
          tip.innerHTML = "ğŸ•Šï¸ ç‚¹å‡»ä¿¡é¸½çœ‹ä¿¡<br>ğŸ† ç‚¹å‡»å±å¹•æ”¾çƒŸèŠ±";
          startAutoLoop();
        }, 3000);
      }

      // ======= äº¤äº’é€»è¾‘ï¼šä¿¡é¸½ä¸ä¿¡çº¸åˆ‡æ¢ =======
      
      // ç‚¹å‡»ä¿¡é¸½ -> å±•å¼€ä¿¡çº¸
      dove.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘çƒŸèŠ±
        if(stage === STAGE.LOOP) {
          showLetter();
        }
      });

      // ç‚¹å‡»é®ç½© -> æ”¶èµ·ä¿¡çº¸
      mask.addEventListener('click', (e) => {
        e.stopPropagation();
        hideLetter();
      });

      function showLetter() {
        // éšè—ä¿¡é¸½
        dove.classList.remove('rest');
        dove.style.opacity = 0; // ä¸´æ—¶éšè—
        
        // æ˜¾ç¤ºä¿¡çº¸
        paper.classList.remove('fold');
        paper.classList.add('show');
        mask.classList.add('show');
        
        tip.style.opacity = 0; // çœ‹ä¿¡æ—¶éšè—æç¤º
      }

      function hideLetter() {
        // æ”¶èµ·ä¿¡çº¸
        paper.classList.add('fold');
        paper.classList.remove('show');
        mask.classList.remove('show');
        
        // æ˜¾ç¤ºä¿¡é¸½
        dove.style.opacity = 1;
        dove.classList.add('rest');
        
        tip.style.opacity = 1; // æ¢å¤æç¤º
      }


      let autoLoopTimer=null;
      function startAutoLoop(){
        if(autoLoopTimer) clearInterval(autoLoopTimer);
        autoLoopTimer = setInterval(()=>{
          if(stage!==STAGE.LOOP) return;
          // å¦‚æœä¿¡çº¸æ‰“å¼€ä¸­ï¼Œå‡å°‘è‡ªåŠ¨çƒŸèŠ±é¢‘ç‡æˆ–åœæ­¢ï¼Œé¿å…å¹²æ‰°é˜…è¯»? 
          // ä¿æŒåŸæœ‰é€»è¾‘ï¼šç»§ç»­æ”¾çƒŸèŠ±åšèƒŒæ™¯
          launchFirework();
        }, rand(5000,8000));
      }

      // ======= ç‚¹å‡»äº¤äº’ =======
      let isProcessingClick = false;

      function handleClick(e){
        // å°è¯•è§¦å‘éŸ³ä¹
        tryPlayAudio();

        const p = e.touches ? e.touches[0] : e;
        const x = p.clientX;
        const y = p.clientY;

        // æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦æ˜¯ä¿¡é¸½æˆ–ä¿¡çº¸å†…éƒ¨ (è™½ç„¶ stopPropagation å·²å¤„ç†ï¼ŒåŒé‡ä¿é™©)
        if (e.target.closest('#dove') || e.target.closest('#paper')) return;

        if(stage===STAGE.FIREWORKS){
          if (isProcessingClick) return;

          if (blessingIndex < blessingChars.length) {
            isProcessingClick = true;
            const ch = blessingChars[blessingIndex];

            launchFirework(x, y, 1, ()=>{
              // é˜²æ­¢é‡å¤ç‚¹å‡»å¯¼è‡´é”™ä½
              if (blessingIndex < blessingChars.length && ch === blessingChars[blessingIndex]) {
                blessingShown += ch;
                blessingIndex++;
                if(blessingIndex>=blessingChars.length){
                  setTimeout(startStage2, 600);
                }
              }
              setTimeout(() => { isProcessingClick = false; }, 200);
            });
          } else {
            launchFirework(x, y, 1);
          }
        } else if(stage===STAGE.LOOP){
          // åªæœ‰åœ¨ä¿¡çº¸æ²¡æ‰“å¼€æ—¶ï¼Œç‚¹å‡»å±å¹•æ‰æ”¾çƒŸèŠ± (å¯é€‰ä½“éªŒä¼˜åŒ–ï¼Œè¿™é‡Œå…è®¸èƒŒæ™¯æ”¾çƒŸèŠ±)
          // å¦‚æœ mask æ˜¾ç¤ºä¸­ï¼ŒhandleClick ä¸ä¼šè¢«è§¦å‘ï¼Œå› ä¸º mask é®ä½äº† canvas
          launchFirework(x, y);
        }
      }

      // ç»‘å®šåˆ° window å¯èƒ½ä¼šæ•è· mask çš„ç‚¹å‡»ï¼Œæ‰€ä»¥è¿™é‡Œè¦æ³¨æ„
      // mask æœ‰ stopPropagationï¼Œæ‰€ä»¥ç‚¹å‡» mask ä¸ä¼šè§¦å‘è¿™é‡Œçš„ handleClick
      window.addEventListener('click', handleClick, { passive:false });
      window.addEventListener('touchstart', handleClick, { passive:false });

      // ======= ä¸»æ¸²æŸ“å¾ªç¯ =======
      function animate(){
        requestAnimationFrame(animate);

        // é˜²æ­¢åœ¨ resize åæœªåŠæ—¶æ›´æ–°
        resize(false);

        ctx.clearRect(0,0,W,H);

        // èƒŒæ™¯æ˜Ÿç‚¹ï¼ˆè½»å¾®ï¼‰
        ctx.save();
        for(let i=0;i<18;i++){
          ctx.globalAlpha=0.06;
          ctx.fillStyle="white";
          ctx.beginPath();
          ctx.arc(rand(0,W), rand(0,H*0.6), rand(1,2.2), 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();

        // æ›´æ–°/ç»˜åˆ¶çƒŸèŠ± & ç²’å­
        for(let i=fireworks.length-1;i>=0;i--){
          const f=fireworks[i];
          if(!f.update()) fireworks.splice(i,1);
          else f.draw();
        }
        for(let i=particles.length-1;i>=0;i--){
          const p=particles[i];
          if(!p.update()) particles.splice(i,1);
          else p.draw();
        }

        drawBlessingText();
        drawNYEText();
      }

      // å¼€å§‹æ—¶æ”¾å‡ ä¸ªçƒŸèŠ±å¼•å¯¼ç”¨æˆ·
      setTimeout(() => {
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            launchFirework(
              rand(W * 0.3, W * 0.7),
              rand(H * 0.3, H * 0.5),
              0.8
            );
          }, i * 500);
        }
      }, 1000);

      animate();
    })();
  </script>
</body>
</html>
